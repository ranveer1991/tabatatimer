<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Mobility Gemma Local</title>
    <style>
        :root { --w: #30d158; --a: #ff9f0a; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: #000; color: #fff; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #setup, #timer { padding: 20px; width: 100%; max-width: 400px; text-align: center; }
        #timer { display: none; }
        .progress-bar { width: 100%; height: 8px; background: #333; border-radius: 4px; margin: 20px 0; overflow: hidden; }
        #fill { height: 100%; background: var(--w); width: 0%; transition: width 0.3s; }
        .btn { padding: 20px; border-radius: 12px; border: none; font-weight: bold; width: 100%; cursor: pointer; background: var(--w); color: #000; font-size: 18px; }
        .ai-tip { font-style: italic; color: #8e8e93; margin-top: 20px; min-height: 50px; padding: 10px; border-radius: 8px; background: #1c1c1e; }
    </style>
</head>
<body>

<div id="setup">
    <h1>Gemma 3 Coach</h1>
    <p>Preparing the 270M local model...</p>
    <div class="progress-bar"><div id="fill"></div></div>
    <p id="status" style="font-size: 12px; color: #666;">Waiting to start...</p>
    <button class="btn" id="startBtn" disabled>Initialize Coach</button>
</div>

<div id="timer">
    <h2 id="ex-name">Ready</h2>
    <div style="font-size: 80px; margin: 20px 0;" id="countdown">10</div>
    <div class="ai-tip" id="ai-advice">Gemma is thinking...</div>
</div>

<script type="module">
    import * as webllm from "https://esm.run/@mlc-ai/web-llm";

    let engine;
    const modelId = "gemma-3-270m-it-q4f16_1-MLC"; // The specific 270M local build

    async function initGemma() {
        document.getElementById('startBtn').disabled = true;
        
        try {
            engine = await webllm.CreateMLCEngine(modelId, {
                initProgressCallback: (report) => {
                    const p = Math.floor(report.progress * 100);
                    document.getElementById('fill').style.width = p + "%";
                    document.getElementById('status').innerText = report.text;
                    if (p === 100) document.getElementById('startBtn').disabled = false;
                }
            });
            
            document.getElementById('startBtn').innerText = "Begin Workout";
            document.getElementById('startBtn').onclick = startWorkout;
        } catch (e) {
            document.getElementById('status').innerText = "WebGPU Error: Use Safari on iOS 17+";
        }
    }

    async function getGemmaAdvice() {
        const now = new Date();
        const day = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][now.getDay()];
        const prompt = `It's ${day}. You are a poetic mobility coach. Give 1 sentence of advice for back health. Max 15 words.`;
        
        const reply = await engine.chat.completions.create({
            messages: [{ role: "user", content: prompt }]
        });
        document.getElementById('ai-advice').innerText = reply.choices[0].message.content;
    }

    function startWorkout() {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('timer').style.display = 'block';
        getGemmaAdvice();
        // Standard timer logic goes here...
    }

    window.onload = initGemma;
</script>
</body>
</html>
