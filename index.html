<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Mobility Flow AI</title>
    <style>
        :root { 
            --w: #30d158; /* Green */
            --a: #ff9f0a; /* Amber/Orange for Prep */
            --r: #ff453a; 
            --p: #000; 
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom); 
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: -apple-system, system-ui, sans-serif; background: #000; color: #fff; height: 100dvh; overflow: hidden; transition: background 0.4s, color 0.4s; }
        body.work { background: var(--w); color: #000; }
        body.prep { background: var(--a); color: #000; }
        
        #setup, #timer { position: fixed; inset: 0; padding: calc(var(--safe-top) + 20px) 24px calc(var(--safe-bottom) + 20px); display: flex; flex-direction: column; }
        
        /* UI Elements */
        .summary-card { background: #1c1c1e; border-radius: 20px; padding: 16px; margin: 15px 0; }
        .stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #3a3a3c; }
        .intention-box { background: rgba(255,255,255,0.05); border-left: 3px solid var(--w); padding: 12px; border-radius: 8px; font-style: italic; font-size: 14px; margin-bottom: 20px; display: none; }
        
        #timer { display: none; align-items: center; text-align: center; justify-content: space-between; }
        .ex-name { font-size: 32px; font-weight: 800; line-height: 1.2; min-height: 80px; display: flex; align-items: center; justify-content: center; }
        
        /* Ring Animation */
        .ring { position: relative; width: 280px; height: 280px; display: flex; align-items: center; justify-content: center; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; position: absolute; }
        circle { fill: none; stroke-width: 10; stroke-linecap: round; }
        .bg-c { stroke: rgba(0,0,0,0.1); }
        .prog-c { stroke: currentColor; stroke-dasharray: 816; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .time { font-size: 80px; font-weight: 200; font-variant-numeric: tabular-nums; }
        
        /* Controls */
        .next-card { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 15px; width: 100%; backdrop-filter: blur(10px); }
        .btn { padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 700; border: none; width: 100%; cursor: pointer; }
        .start-btn { background: var(--w); color: #000; }
        .start-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .ctrls { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .row-ctrls { display: flex; gap: 12px; width: 100%; }
        .pause-btn { background: rgba(255,255,255,0.2); color: #fff; flex: 2; }
        .skip-btn { background: rgba(255,255,255,0.1); color: #fff; flex: 1; border: 1px solid rgba(255,255,255,0.1); }
        .exit-btn { background: transparent; color: #8e8e93; font-size: 14px; padding: 10px; }

        /* Settings Modal */
        #api-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; padding: 40px 24px; flex-direction: column; gap: 20px; justify-content: center; }
        .settings-btn { position: absolute; top: calc(var(--safe-top) + 10px); right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; opacity: 0.5; z-index: 10; }
        input { background: #1c1c1e; border: 1px solid #3a3a3c; color: #fff; padding: 15px; border-radius: 12px; font-size: 16px; }
    </style>
</head>
<body>

<button class="settings-btn" onclick="toggleSettings()">⚙️</button>

<div id="api-modal">
    <h2 style="margin:0">AI Coach Settings</h2>
    <p style="color: #8e8e93; font-size: 14px;">Enter your Gemini API Key. It stays on your device and is never shared.</p>
    <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key here...">
    <button class="btn start-btn" onclick="saveKey()">Save & Close</button>
    <button class="btn exit-btn" onclick="toggleSettings()">Cancel</button>
</div>

<div id="setup">
    <h1 style="margin:0; font-size: 34px;">Mobility Flow</h1>
    <p id="current-day" style="color:#8e8e93; margin-top:4px">Loading Session...</p>
    
    <div id="intention-card" class="intention-box"></div>

    <div class="summary-card">
        <div class="stat-row"><span>Cycle 1</span><strong>Back</strong></div>
        <div class="stat-row"><span>Cycle 2</span><strong>Hips</strong></div>
        <div class="stat-row"><span>Cycle 3</span><strong>Ankle</strong></div>
        <div class="stat-row"><span>Cycle 4</span><strong>Core</strong></div>
    </div>
    <button class="btn start-btn" id="startBtn">Start Workout</button>
</div>

<div id="timer">
    <div>
        <div id="phase" style="font-size:12px; letter-spacing:2px; font-weight:800; opacity:0.6; text-transform:uppercase">Prepare</div>
        <div id="ex-title" class="ex-name">Ready</div>
        <div id="cycle-step" style="font-size:12px; font-weight:600; opacity:0.5;">Cycle 1/4</div>
    </div>
    <div class="ring">
        <svg viewBox="0 0 300 300">
            <circle class="bg-c" cx="150" cy="150" r="130"></circle>
            <circle id="prog" class="prog-c" cx="150" cy="150" r="130"></circle>
        </svg>
        <div id="time" class="time">10</div>
    </div>
    <div id="next-label" class="next-card">
        <span id="next-label-text" style="font-size:10px; text-transform:uppercase; opacity:0.6; display:block">Next Position</span>
        <span id="next-ex-name" style="font-size:18px; font-weight:600"></span>
    </div>
    <div class="ctrls">
        <div class="row-ctrls">
            <button id="p_btn" class="btn pause-btn">Pause</button>
            <button id="skip_btn" class="btn skip-btn">Skip</button>
        </div>
        <button class="btn exit-btn" id="exitBtn">End Workout</button>
    </div>
</div>

<script>
    const routine = [
        {name: "Back", exercises:[
            {n:"Cat-Cow",d:30, t:"Think string of pearls—move one vertebrae at a time."},
            {n:"Child to Sphinx",d:30, t:"Slink forward from a ball into a proud chest opener."},
            {n:"Pelvic Tilts",d:30, t:"Just tilt the bowl of your pelvis; keep the legs quiet."},
            {n:"Thread Needle (L)",d:15, t:"Reach under like you're grabbing a lost remote."},
            {n:"Thread Needle (R)",d:15, t:"Hips square, let the twist happen in your mid-back."},
            {n:"Tug Knee (L)",d:15, t:"Pull your knee toward your armpit to reset the lower back."},
            {n:"Tug Knee (R)",d:15, t:"Gentle decompression. Feel the hip crease compress."},
            {n:"Crossover Twist (L)",d:15, t:"Keep the opposite shoulder glued to the floor."},
            {n:"Crossover Twist (R)",d:15, t:"Breathe into your ribs; feel the side-body release."}
        ]},
        {name: "Hips", exercises:[
            {n:"Walking Lunge",d:30, t:"Tall Spine. Don't lean! Feel the back hip unzip as you step."},
            {n:"Cossack Squat",d:30, t:"Shift side to side. Keep your heels on the dirt."},
            {n:"Hip Flexor (L)",d:15, t:"Squeeze your left butt cheek to open the front."},
            {n:"Hip Flexor (R)",d:15, t:"Stay upright. Don't arch your lower back."},
            {n:"Hamstring (L)",d:15, t:"Butt back, chest flat. Feel the pull behind the thigh."},
            {n:"Hamstring (R)",d:15, t:"No hunching! Keep that leg as straight as you can."},
            {n:"Cossack Hold (L)",d:15, t:"Sit deep on the left, right toes point to the sky."},
            {n:"Cossack Hold (R)",d:15, t:"Find your edge and breathe through the inner thigh heat."}
        ]},
        {name: "Ankle", exercises:[
            {n:"Walk the Dog",d:30, t:"Drive those heels down. Wake up the Achilles."},
            {n:"Squat to Reach",d:30, t:"Full Body. Deep squat, then reach for the stars."},
            {n:"Calf Rocks",d:30, t:"Slow ballerina toes, then heavy lead-weight heels."},
            {n:"Calf Stretch (L)",d:15, t:"Keep the back leg straight and the heel down."},
            {n:"Calf Stretch (R)",d:15, t:"Steady pressure. Feel the belly of the muscle."},
            {n:"Hamstring (L)",d:15, t:"Pull toes toward your shin to feel the nerve stretch."},
            {n:"Hamstring (R)",d:15, t:"Keep your hips square to the front."},
            {n:"Quad Stretch (L)",d:15, t:"Knees together! Don't let the left knee flare out."},
            {n:"Quad Stretch (R)",d:15, t:"Stand tall. Don't let your lower back arch away."}
        ]},
        {name: "Core", exercises:[
            {n:"Russian Twists",d:20, t:"Wring it Out: Rotate the ribcage, not just the arms."},
            {n:"Sit Ups",d:20, t:"No Momentum: Use the abs to peel yourself off the mat."},
            {n:"Pass the Ball",d:20, t:"Control: Don't let your back pop off the floor as you extend."},
            {n:"Super Mans",d:20, t:"Look down at the floor. Squeeze your back corset."},
            {n:"Dead Bug",d:20, t:"Crush that imaginary grape under your lower back."},
            {n:"Boat Pose",d:20, t:"Shake it out! Keep the chest high and hold on."}
        ]}
    ];

    let currentC = 0, currentE = 0, mode = 'PREP', time = 10, total = 10, interval = null, paused = false;
    let wakeLock = null;
    let guidanceIndices = []; 
    let tipSpokenThisEx = false;
    const synth = window.speechSynthesis;

    // Initialize Date Display
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    document.getElementById('current-day').innerText = `${days[new Date().getDay()]} Session`;

    // AI Coaching Integration
    async function getAiAdvice() {
        const key = localStorage.getItem('GEMINI_KEY');
        if (!key) return "Let's find some flow and move with intention today.";

        const now = new Date();
        const timeContext = now.getHours() < 12 ? 'morning' : now.getHours() < 18 ? 'afternoon' : 'evening';
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `You are a world-class mobility coach. Today is ${days[now.getDay()]} ${timeContext}. The user is starting a mobility flow (Back, Hips, Ankle, Core). Give 1 short, peppy, insightful coaching sentence for the start. Max 20 words.` }]}]
                })
            });
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        } catch (err) {
            return "Focus on your breath and move like you're underwater today.";
        }
    }

    function toggleSettings() {
        const m = document.getElementById('api-modal');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        if (localStorage.getItem('GEMINI_KEY')) document.getElementById('apiKeyInput').value = localStorage.getItem('GEMINI_KEY');
    }

    function saveKey() {
        localStorage.setItem('GEMINI_KEY', document.getElementById('apiKeyInput').value);
        toggleSettings();
    }

    function setupGuidance() {
        const allEx = [];
        routine.forEach((c, cIdx) => c.exercises.forEach((e, eIdx) => allEx.push(`${cIdx}-${eIdx}`)));
        const count = Math.floor(allEx.length * 0.3);
        guidanceIndices = allEx.sort(() => 0.5 - Math.random()).slice(0, count);
    }

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
    }

    function speak(t) {
        synth.cancel();
        const m = new SpeechSynthesisUtterance(t);
        m.rate = 1.15; m.pitch = 1.1;
        synth.speak(m);
    }

    function updateUI() {
        const ex = routine[currentC].exercises[currentE];
        const next = routine[currentC].exercises[currentE + 1] || (routine[currentC + 1] ? routine[currentC+1].exercises[0] : null);
        document.getElementById('time').innerText = time;
        document.getElementById('ex-title').innerText = ex.n;
        document.getElementById('phase').innerText = mode === 'PREP' ? 'Prepare' : 'Go';
        document.getElementById('cycle-step').innerText = `Cycle ${currentC + 1}/4: ${routine[currentC].name}`;
        document.getElementById('next-ex-name').innerText = next ? next.n : 'Finish';
        const offset = 816 - (816 * (time / total));
        document.getElementById('prog').style.strokeDashoffset = isNaN(offset) ? 0 : offset;
        document.body.className = mode === 'WORK' ? 'work' : 'prep';
    }

    function tick() {
        if (paused) return;
        if (time > 0) {
            time--;
            
            // Trigger Tip at 2/3rd mark
            if (mode === 'WORK' && !tipSpokenThisEx) {
                if (time <= Math.floor(total / 3) && guidanceIndices.includes(`${currentC}-${currentE}`)) {
                    speak(routine[currentC].exercises[currentE].t);
                    tipSpokenThisEx = true; 
                }
            }

            if (time <= 3 && time > 0) speak(time);
            updateUI();
        } else { nextStep(); }
    }

    function nextStep() {
        if (mode === 'PREP') {
            mode = 'WORK';
            const ex = routine[currentC].exercises[currentE];
            time = total = ex.d;
            tipSpokenThisEx = false;
            speak(ex.n); 
        } else {
            currentE++;
            if (currentE >= routine[currentC].exercises.length) { currentE = 0; currentC++; }
            if (currentC >= routine.length) { completeWorkout(); return; }
            mode = 'PREP';
            time = total = 8;
            speak("Next: " + routine[currentC].exercises[currentE].n);
        }
        updateUI();
    }

    function completeWorkout() {
        clearInterval(interval);
        if (wakeLock) wakeLock.release().then(() => wakeLock = null);
        speak("Workout Complete. Great job.");
        setTimeout(() => location.reload(), 3000);
    }

    document.getElementById('startBtn').addEventListener('click', async function() {
        this.innerText = "Consulting AI Coach...";
        this.disabled = true;

        const advice = await getAiAdvice();
        document.getElementById('intention-card').innerText = advice;
        document.getElementById('intention-card').style.display = 'block';
        
        setupGuidance();
        requestWakeLock();
        
        speak(advice);

        setTimeout(() => {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('timer').style.display = 'flex';
            updateUI();
            interval = setInterval(tick, 1000);
            speak("Starting with " + routine[0].exercises[0].n);
        }, 3500);
    });

    document.getElementById('p_btn').addEventListener('click', function() {
        paused = !paused;
        this.innerText = paused ? 'Resume' : 'Pause';
    });

    document.getElementById('skip_btn').addEventListener('click', () => { time = 0; nextStep(); });

    document.getElementById('exitBtn').addEventListener('click', () => {
        if (confirm("Stop workout?")) location.reload();
    });
</script>
</body>
</html>
